{% extends '_base.html' %}
{% block head %}
{{ super() }}
<style>
/* Base Styles (Copied from your admin_settings.html) */
.admin-settings-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem;
}
.card {
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid #e5e7eb;
}
.card-title {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 600;
  color: #1f2937;
}
.btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  font-size: 0.875rem;
  font-weight: 500;
  text-decoration: none;
  border: 1px solid transparent;
  cursor: pointer;
  transition: all 0.2s ease;
}
.btn-primary { background: #3b82f6; color: white; border-color: #3b82f6; }
.btn-primary:hover { background: #2563eb; border-color: #2563eb; }
.btn-secondary { background: white; color: #374151; border-color: #d1d5db; }
.btn-secondary:hover { background: #f9fafb; border-color: #9ca3af; }
.btn-success { background: #10b981; color: white; border-color: #10b981; }
.btn-success:hover { background: #059669; border-color: #059669; }
.btn-danger { background: #ef4444; color: white; border-color: #ef4444; }
.btn-danger:hover { background: #dc2626; border-color: #dc2626; }
.btn-sm { padding: 0.25rem 0.75rem; font-size: 0.75rem; }
.btn:disabled { opacity: 0.6; cursor: not-allowed; }

/* Modal Styles */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}
.modal.active { display: flex; }
.modal-content {
  background: white;
  border-radius: 12px;
  width: 90%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
}
.modal-header {
  padding: 1.5rem;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.modal-title { margin: 0; font-size: 1.25rem; font-weight: 600; color: #1f2937; }
.modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: #6b7280;
  cursor: pointer;
  padding: 0.25rem;
  border-radius: 4px;
  transition: all 0.2s ease;
}
.modal-close:hover { background: #f3f4f6; color: #374151; }
.modal-body { padding: 1.5rem; }
.modal-footer {
  padding: 1.5rem;
  border-top: 1px solid #e5e7eb;
  display: flex;
  justify-content: flex-end;
  gap: 0.75rem;
}

/* Form Styles */
.admin-form { display: grid; gap: 1rem; }
.form-group { display: flex; flex-direction: column; gap: 0.5rem; }
.form-label { font-size: 0.875rem; font-weight: 600; color: #374151; }
.form-input, .form-select {
  padding: 0.5rem;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 0.875rem;
  transition: border-color 0.2s ease;
}
.form-input:focus, .form-select:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}
.form-checkbox-group {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.alert { padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.875rem; }
.alert-error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
.loading { opacity: 0.6; pointer-events: none; }

/* --- NEW APPOINTMENT STYLES --- */
.appt-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem;
}
.appt-header {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 1.5rem;
}
.appt-header h1 {
  margin: 0;
  font-size: 2.5rem;
  font-weight: 700;
  color: #1f2937;
}

.filter-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
}
.filter-card-header h2 {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 600;
  color: #1f2937;
}

/* Filter Styles */
.appt-filter-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
  padding-bottom: 1.5rem;
  border-bottom: 1px solid #e5e7eb;
}
.filter-btn {
  display: inline-block;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  font-size: 0.875rem;
  font-weight: 500;
  text-decoration: none;
  border: 1px solid #d1d5db;
  background: #f9fafb;
  color: #374151;
  cursor: pointer;
  transition: all 0.2s ease;
}
.filter-btn:hover {
  background: #f3f4f6;
  border-color: #9ca3af;
}
.filter-btn.active {
  background: #3b82f6;
  color: white;
  border-color: #3b82f6;
}
.appt-filter-form {
  display: grid;
  grid-template-columns: 1fr;
  gap: 1.5rem;
}
.appt-filter-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  align-items: flex-end;
}
.appt-filter-row-dates {
  display: grid;
  grid-template-columns: 1fr 1fr 0.5fr 1fr;
  gap: 1rem;
  align-items: flex-end;
}
#end-date-group {
  transition: opacity 0.2s ease;
  opacity: 0; /* Will be made visible by JS */
}
#end-date-group.visible {
  opacity: 1;
}
.form-buttons-group {
  justify-content: flex-end; 
  flex-direction: row; 
  gap: 0.5rem; 
  align-items: center;
}
@media (max-width: 1024px) {
  .appt-filter-row {
    grid-template-columns: 1fr;
  }
  .appt-filter-row-dates {
    grid-template-columns: 1fr 1fr;
  }
}
@media (max-width: 768px) {
  .appt-filter-row-dates {
    grid-template-columns: 1fr;
  }
  .form-buttons-group {
    justify-content: flex-start;
  }
}

/* Group Styles */
.appt-group {
  margin-top: 2rem;
}
.appt-group-header {
  font-size: 1.25rem;
  font-weight: 600;
  color: #1f2937;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid #e5e7eb;
  margin-bottom: 1.5rem;
}
.appt-group-header .date-day {
  color: #3b82f6;
}
.no-appointments-card {
  text-align: center;
  padding: 3rem;
  background: #f9fafb;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}
.no-appointments-icon {
  font-size: 2.5rem;
  color: #9ca3af;
}
.no-appointments-text {
  font-size: 1rem;
  color: #6b7280;
  margin-top: 0.5rem;
}

/* Vertical Card Styles */
.appt-card-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 1.5rem;
}

.appt-card {
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  display: flex;
  flex-direction: column;
  transition: box-shadow 0.2s ease;
  min-height: 330px; 
}
.appt-card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}
/* Patient Chip Header */
.appt-card-patient-chip {
  display: block;
  padding: 1.25rem;
  border-bottom: 1px solid #e5e7eb;
  text-decoration: none;
  background: #f9fafb;
  border-radius: 12px 12px 0 0;
  transition: background-color 0.2s ease;
  overflow: hidden; 
}
.appt-card-patient-chip:hover {
  background: #f3f4f6;
}
.appt-card-patient-name {
  font-size: 1.125rem;
  font-weight: 600;
  color: #111827;
  margin-bottom: 0.5rem;
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.appt-card-patient-details {
  display: flex;
  justify-content: center; /* Centered details */
  gap: 1rem; /* Added more gap */
  font-size: 0.875rem;
  color: #6b7280;
  white-space: nowrap; /* Prevent wrapping */
  overflow: hidden;
}
/* Stop text from spilling out */
.appt-card-patient-details span {
  overflow: hidden;
  text-overflow: ellipsis;
  flex-shrink: 1;
}

.appt-card-body {
  padding: 1.25rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  flex-grow: 1; /* Makes body fill space */
}
.appt-card-row {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-size: 0.875rem;
  color: #374151;
}
.appt-card-icon {
  width: 20px;
  height: 20px;
  color: #6b7280;
  flex-shrink: 0; /* Prevent icon from shrinking */
}
.appt-card-reason {
  font-style: italic;
  color: #6b7280;
}
.appt-card-footer {
  padding: 1rem 1.25rem;
  border-top: 1px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 0.5rem;
}
/* MODIFIED: Ensure buttons stay on one line */
.appt-card-footer-buttons {
  display: flex;
  gap: 0.25rem;
  flex-shrink: 0; /* Prevent buttons from wrapping */
}

/* Status Button Styles */
.status-button {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.25rem 0.75rem;
  border-radius: 6px;
  font-size: 0.875rem;
  font-weight: 500;
  border: 1px solid transparent;
  cursor: pointer;
  transition: all 0.2s ease;
  flex-shrink: 0; /* Prevent button from shrinking/wrapping */
}
.status-scheduled { background: #fef9c3; color: #713f12; border-color: #fde68a; }
.status-scheduled:hover { background: #fef3c7; }
.status-checked_in { background: #ffe4e1; color: #991b1b; border-color: #fecaca; }
.status-checked_in:hover { background: #fee2e2; }
.status-done { background: #d1fae5; color: #065f46; border-color: #a7f3d0; }
.status-done:hover { background: #bbf7d0; }
.status-cancelled { background: #e5e7eb; color: #374151; border-color: #d1d5db; }
.status-cancelled:hover { background: #e0e7ff; }

/* Status Modal */
.status-modal-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}
.status-modal-btn {
  width: 100%;
  padding: 1.5rem 1rem;
  font-size: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="appt-container">
  
  <!-- Header -->
  <div class="appt-header">
    <h1>Appointments</h1>
  </div>

  <!-- Filter Bar -->
  <div class="card">
    <div class="filter-card-header">
      <h2>Filters</h2>
      <button class="btn btn-primary" type="button" onclick="openApptModal()">
        + New Appointment
      </button>
    </div>

    <form id="appt-form-main" method="GET" action="{{ url_for('appointments.vanilla') }}" data-today="{{ today_str }}">
      
      <!-- Quick Filter Buttons -->
      <div class="appt-filter-buttons">
        <a href="{{ url_for('appointments.vanilla', start_date=today_str, end_date=today_str, use_range='on') }}" 
           class="filter-btn {% if request.args.get('start_date') == today_str and request.args.get('end_date') == today_str and use_range %}active{% endif %}">
          Today
        </a>
        <a href="{{ url_for('appointments.vanilla', start_date=yesterday_str, end_date=yesterday_str, use_range='on') }}" 
           class="filter-btn {% if request.args.get('start_date') == yesterday_str and request.args.get('end_date') == yesterday_str and use_range %}active{% endif %}">
          Yesterday
        </a>
        <a href="{{ url_for('appointments.vanilla', start_date=tomorrow_str, end_date=tomorrow_str, use_range='on') }}" 
           class="filter-btn {% if request.args.get('start_date') == tomorrow_str and request.args.get('end_date') == tomorrow_str and use_range %}active{% endif %}">
          Tomorrow
        </a>
        <a href="{{ url_for('appointments.vanilla') }}" 
           class="filter-btn {% if not request.args.get('start_date') and not use_range %}active{% endif %}">
          All Days
        </a>
      </div>

      <!-- Main Filter Form -->
      <div class="appt-filter-form">
        <!-- Search and Doctor Row -->
        <div class="appt-filter-row">
          <div class="form-group">
            <label class="form-label" for="search_term">Search Patient</label>
            <input type="text" id="search_term" name="search_term" class="form-input" value="{{ request.args.get('search_term', '') }}" placeholder="Name, phone, or file...">
          </div>
          <div class="form-group">
            <label class="form-label" for="doctor_id">Doctor</label>
            <select id="doctor_id" name="doctor_id" class="form-select">
              <option value="all" {% if selected_doctor == 'all' %}selected{% endif %}>All Doctors</option>
              {% for doctor in doctors %}
                <option value="{{ doctor.id }}" {% if selected_doctor|string == doctor.id|string %}selected{% endif %}>{{ doctor.doctor_label }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        
        <!-- Date Filter Row -->
        <div class="appt-filter-row-dates">
          <div class="form-group">
            <label class="form-label" for="start_date">Date</label>
            <input type="date" id="start_date" name="start_date" class="form-input" value="{{ request.args.get('start_date', '') }}">
          </div>
          
          <div class="form-group" id="end-date-group" style="visibility: {% if use_range %}visible{% else %}hidden{% endif %};">
            <label class="form-label" for="end_date">End Date</label>
            <input type="date" id="end_date" name="end_date" class="form-input" value="{{ request.args.get('end_date', '') }}">
          </div>

          <div class="form-group" style="justify-content: flex-end;">
            <label class="form-checkbox-group">
              <input type="checkbox" id="use_range_check" name="use_range" value="on" {% if use_range %}checked{% endif %}>
              <span>Use Range</span>
            </label>
          </div>

          <div class="form-group form-buttons-group">
            <a href="{{ url_for('appointments.vanilla') }}" class="btn btn-secondary">Clear</a>
            <button type="submit" class="btn btn-primary">Search</button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Appointment List -->
  {% if grouped_appointments %}
    {% for date_iso, appts in grouped_appointments.items() %}
    <div class="appt-group">
      <h2 class="appt-group-header">
        {% if date_iso == today_str %}
          <span class="date-day">Today</span> - {{ appts[0].start_time.strftime('%A, %B %d, %Y') }}
        {% elif date_iso == yesterday_str %}
          <span class="date-day">Yesterday</span> - {{ appts[0].start_time.strftime('%A, %B %d, %Y') }}
        {% elif date_iso == tomorrow_str %}
          <span class="date-day">Tomorrow</span> - {{ appts[0].start_time.strftime('%A, %B %d, %Y') }}
        {% else %}
          {{ appts[0].start_time.strftime('%A, %B %d, %Y') }}
        {% endif %}
        ({{ appts|length }})
      </h2>
      <div class="appt-card-grid">
        {% for appt in appts %}
        <div class="appt-card" data-appt-id="{{ appt.id }}">
          
          <!-- Patient Chip Header -->
          <a href="{{ url_for('patients.patient_detail', pid=appt.patient.id) if appt.patient else '#' }}" target="_blank" class="appt-card-patient-chip">
            <div class="appt-card-patient-name">{{ appt.patient.full_name }}</div>
            <div class="appt-card-patient-details">
              <span>üìÅ {{ appt.patient.short_id or '‚Äî' }}</span>
              <span>üìû {{ appt.patient.phone or '‚Äî' }}</span>
            </div>
          </a>
          
          <!-- Card Body -->
          <div class="appt-card-body">
            <div class="appt-card-row">
              <span class="appt-card-icon">üïí</span>
              <strong>{{ appt.start_time.strftime('%I:%M %p') }}</strong>
            </div>
            <div class="appt-card-row">
              <span class="appt-card-icon">üë®‚Äç‚öïÔ∏è</span>
              <span>Dr. {{ appt.doctor.doctor_label }}</span>
            </div>
            <div class="appt-card-row appt-card-reason">
              <span class="appt-card-icon">üìù</span>
              <span>{{ appt.title or 'No reason provided' }}</span>
            </div>
          </div>

          <!-- Card Footer -->
          <div class="appt-card-footer">
            <button 
              class="status-button status-{{ appt.status }}" 
              onclick="openStatusModal('{{ appt.id }}', '{{ appt.status }}')">
              {{ appt.status|capitalize }}
            </button>
            <!-- MODIFIED: Buttons back on one line, emojis removed -->
            <div class="appt-card-footer-buttons">
              <button class="btn btn-secondary btn-sm" onclick="openViewModal('{{ appt.id }}')">View</button>
              <button class="btn btn-secondary btn-sm" onclick="openApptModal('{{ appt.id }}')">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="openDeleteModal('{{ appt.id }}', {{ appt.patient.full_name | tojson }})">Delete</button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  {% else %}
    <div class="card no-appointments-card">
      <div class="no-appointments-icon">ü§∑‚Äç‚ôÇÔ∏è</div>
      <h2 class="card-title">No Appointments Found</h2>
      <p class="no-appointments-text">Try adjusting your filters or selecting a different date.</p>
    </div>
  {% endif %}

</div>

<!-- --- MODALS --- -->

<!-- Add/Edit Appointment Modal -->
<div id="appt-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="appt-modal-title" class="modal-title">New Appointment</h3>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div id="appt-alert" class="alert alert-error" style="display: none;"></div>
      <form id="appt-form" class="admin-form">
        <input type="hidden" id="appt-id" name="id">

        <div class="form-group">
          <label class="form-label">Patient *</label>
          <select id="appt-patient" class="form-select" required>
            <option value="">Select a patient...</option>
            {% for p in all_patients %}
            <option value="{{ p.id }}">{{ p.full_name }} ({{ p.short_id }})</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Doctor *</label>
          <select id="appt-doctor" class="form-select" required>
            {% for d in doctors %}
            <option value="{{ d.id }}">{{ d.doctor_label }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="form-group">
            <label class="form-label">Date *</label>
            <input type="date" id="appt-date" class="form-input" required value="{{ today_str }}">
          </div>
          <div class="form-group">
            <label class="form-label">Start Time *</label>
            <input type="time" id="appt-start-time" class="form-input" required>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Status *</label>
          <select id="appt-status" class="form-select" required>
            <option value="scheduled">Scheduled</option>
            <option value="checked_in">Pending</option>
            <option value="done">Done</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Reason / Title</label>
          <input type="text" id="appt-reason" class="form-input" placeholder="e.g., Checkup, Filling...">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button id="appt-submit-btn" class="btn btn-primary" onclick="saveAppt()">Create Appointment</button>
    </div>
  </div>
</div>

<!-- View Modal -->
<div id="view-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">View Appointment</h3>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div id="view-alert" class="alert alert-error" style="display: none;"></div>
      <div id="view-content" class="admin-form">
        <!-- Content will be loaded here by JavaScript -->
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Close</button>
    </div>
  </div>
</div>

<!-- Change Status Modal -->
<div id="status-modal" class="modal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <h3 class="modal-title">Change Status</h3>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="status-appt-id">
      <div id="status-alert" class="alert alert-error" style="display: none;"></div>
      <div class="status-modal-grid">
        <button class="btn status-modal-btn status-scheduled" onclick="updateStatus('scheduled')">Scheduled</button>
        <button class="btn status-modal-btn status-checked_in" onclick="updateStatus('checked_in')">Pending</button>
        <button class="btn status-modal-btn status-done" onclick="updateStatus('done')">Done</button>
        <button class="btn status-modal-btn status-cancelled" onclick="updateStatus('cancelled')">Cancelled</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div id="delete-modal" class="modal">
  <div class="modal-content" style="max-width: 450px;">
    <div class="modal-header">
      <h3 class="modal-title">Delete Appointment</h3>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="delete-id">
      <p>Are you sure you want to delete the appointment for <strong id="delete-name"></strong>? This action cannot be undone.</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button id="delete-submit-btn" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<script>
// This is a small script, just like your admin_settings.html
// It only handles modals and the "Use Range" checkbox.

// Get CSRF token from meta tag
const csrfMetaTag = document.querySelector('meta[name="csrf-token"]');
const CSRF_TOKEN = csrfMetaTag ? (csrfMetaTag.getAttribute('content') || '') : '';

// --- Modal Functions ---
function openApptModal(apptId = null) {
  const modal = document.getElementById('appt-modal');
  const title = document.getElementById('appt-modal-title');
  const submitBtn = document.getElementById('appt-submit-btn');
  const alert = document.getElementById('appt-alert');
  
  alert.style.display = 'none';
  document.getElementById('appt-form').reset();
  document.getElementById('appt-id').value = '';
  
  const today = document.getElementById('appt-form-main').dataset.today || new Date().toISOString().split('T')[0];
  document.getElementById('appt-date').value = today; // Default to today

  if (apptId) {
    // This is an EDIT
    title.textContent = 'Edit Appointment';
    submitBtn.textContent = 'Update Appointment';
    loadApptData(apptId, 'edit');
  } else {
    // This is a NEW appointment
    title.textContent = 'New Appointment';
    submitBtn.textContent = 'Create Appointment';
    modal.classList.add('active');
  }
}

function openViewModal(apptId) {
  const modal = document.getElementById('view-modal');
  const content = document.getElementById('view-content');
  const alert = document.getElementById('view-alert');
  content.innerHTML = '<p>Loading...</p>';
  alert.style.display = 'none';
  modal.classList.add('active');
  loadApptData(apptId, 'view');
}

function openStatusModal(apptId, currentStatus) {
  document.getElementById('status-appt-id').value = apptId;
  document.querySelectorAll('.status-modal-btn').forEach(btn => {
    btn.disabled = false;
    if (btn.classList.contains('status-' + currentStatus)) {
      btn.disabled = true;
    }
  });
  document.getElementById('status-modal').classList.add('active');
}

async function loadApptData(apptId, mode = 'edit') {
  const alert = document.getElementById(mode === 'edit' ? 'appt-alert' : 'view-alert');
  try {
    const response = await fetch(`/api/appointments/${apptId}`, { credentials: 'same-origin' });
    if (!response.ok) {
        throw new Error(`Server responded with status ${response.status}`);
    }
    const appt = await response.json();

    if (appt.error) { throw new Error(appt.error); }
    
    // Format date/time for inputs
    const start = new Date(appt.start_time);
    
    // Handle timezone offset for date/time inputs
    const toLocalISOString = (date) => {
        const offset = date.getTimezoneOffset() * 60000;
        const localDate = new Date(date.getTime() - offset);
        return localDate.toISOString();
    }
    
    const localStart = toLocalISOString(start);
    
    if (mode === 'edit') {
      document.getElementById('appt-id').value = appt.id;
      document.getElementById('appt-patient').value = appt.patient_id;
      document.getElementById('appt-doctor').value = appt.doctor_id;
      document.getElementById('appt-status').value = appt.status;
      document.getElementById('appt-reason').value = appt.title || '';
      document.getElementById('appt-date').value = localStart.split('T')[0];
      document.getElementById('appt-start-time').value = localStart.split('T')[1].substring(0, 5);
      // We don't need end time, it's calculated
      document.getElementById('appt-modal').classList.add('active');
    } else {
      // Build View Modal Content
      const contentEl = document.getElementById('view-content');
      contentEl.innerHTML = `
        <div class="form-group">
          <label class="form-label">Patient</label>
          <div class="form-input" style="background:#f9fafb;">${appt.patient_name}</div>
        </div>
        <div class="form-group">
          <label class="form-label">Time</label>
          <div class="form-input" style="background:#f9fafb;">${start.toLocaleString('en-US', {dateStyle: 'long', timeStyle: 'short'})}</div>
        </div>
        <div class="form-group">
          <label class="form-label">Doctor</label>
          <div class="form-input" style="background:#f9fafb;">${appt.doctor_name}</div>
        </div>
        <div class="form-group">
          <label class="form-label">Status</label>
          <div class="form-input" style="background:#f9fafb;">${appt.status.charAt(0).toUpperCase() + appt.status.slice(1)}</div>
        </div>
        <div class="form-group">
          <label class="form-label">Reason</label>
          <div class="form-input" style="background:#f9fafb; min-height: 60px;">${appt.title || '‚Äî'}</div>
        </div>
      `;
    }

  } catch (error) {
    alert.textContent = 'Error loading appointment data: ' + error.message;
    alert.style.display = 'block';
  }
}

async function saveAppt() {
  const submitBtn = document.getElementById('appt-submit-btn');
  const alert = document.getElementById('appt-alert');
  
  const apptData = {
    id: document.getElementById('appt-id').value || null,
    patient_id: document.getElementById('appt-patient').value,
    doctor_id: document.getElementById('appt-doctor').value,
    date: document.getElementById('appt-date').value,
    start_time: document.getElementById('appt-start-time').value,
    // End time is no longer sent from here
    status: document.getElementById('appt-status').value,
    title: document.getElementById('appt-reason').value
  };

  // Validation
  if (!apptData.patient_id || !apptData.doctor_id || !apptData.date || !apptData.start_time) {
    alert.textContent = 'Please fill in all required fields (*).';
    alert.style.display = 'block';
    return;
  }

  submitBtn.disabled = true;
  submitBtn.textContent = 'Saving...';
  submitBtn.classList.add('loading');

  try {
    const response = await fetch('/api/appointments/save', {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
      body: JSON.stringify(apptData)
    });
    const result = await response.json();

    if (result.success) {
      closeModal();
      location.reload(); // Easiest way to show the new data
    } else {
      alert.textContent = result.error || 'Failed to save appointment.';
      alert.style.display = 'block';
    }
  } catch (error) {
    alert.textContent = 'An error occurred: ' + error.message;
    alert.style.display = 'block';
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = apptData.id ? 'Update Appointment' : 'Create Appointment';
    submitBtn.classList.remove('loading');
  }
}

async function updateStatus(newStatus) {
  const apptId = document.getElementById('status-appt-id').value;
  const alert = document.getElementById('status-alert');
  alert.style.display = 'none';

  try {
    const response = await fetch('/api/appointments/status', {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
      body: JSON.stringify({ id: apptId, status: newStatus })
    });
    const result = await response.json();

    if (result.success) {
      closeModal();
      location.reload();
    } else {
      alert.textContent = result.error || 'Failed to update status.';
      alert.style.display = 'block';
    }
  } catch (error) {
    alert.textContent = 'An error occurred: ' + error.message;
    alert.style.display = 'block';
  }
}

function openDeleteModal(apptId, patientName) {
  document.getElementById('delete-id').value = apptId;
  document.getElementById('delete-name').textContent = patientName;
  document.getElementById('delete-modal').classList.add('active');
}

async function confirmDelete() {
  const submitBtn = document.getElementById('delete-submit-btn');
  const apptId = document.getElementById('delete-id').value;
  
  submitBtn.disabled = true;
  submitBtn.textContent = 'Deleting...';
  submitBtn.classList.add('loading');

  try {
    const response = await fetch('/api/appointments/delete', {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
      body: JSON.stringify({ id: apptId })
    });
    const result = await response.json();

    if (result.success) {
      closeModal();
      location.reload();
    } else {
      alert(result.error || 'Failed to delete appointment.');
    }
  } catch (error) {
    alert('An error occurred: ' + error.message);
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Delete';
    submitBtn.classList.remove('loading');
  }
}

function closeModal() {
  document.querySelectorAll('.modal').forEach(modal => {
    modal.classList.remove('active');
  });
}

// --- Checkbox Logic ---
document.addEventListener('DOMContentLoaded', function() {
  const useRangeCheckbox = document.getElementById('use_range_check');
  const endDateGroup = document.getElementById('end-date-group');
  const startDateInput = document.getElementById('start_date');
  const endDateInput = document.getElementById('end_date');

  // Set initial visibility state on load
  const setEndDateVisibility = () => {
    if (useRangeCheckbox.checked) {
      endDateGroup.style.visibility = 'visible';
    } else {
      endDateGroup.style.visibility = 'hidden';
    }
  };
  
  setEndDateVisibility(); // Run on page load

  useRangeCheckbox.addEventListener('change', function() {
    setEndDateVisibility(); // Run on change
    if (!this.checked) {
      endDateInput.value = startDateInput.value; // Set end date to start date if range is off
    }
  });

  startDateInput.addEventListener('change', function() {
    // If range isn't checked, keep end-date in sync with start-date
    if (!useRangeCheckbox.checked) {
      endDateInput.value = this.value;
    }
    // Also, ensure end-date is never before start-date
    if (endDateInput.value < this.value) {
      endDateInput.value = this.value;
    }
    endDateInput.min = this.value; // Set min attribute
  });
});

// Close modal on outside click
document.addEventListener('click', function(event) {
  const modals = document.querySelectorAll('.modal');
  modals.forEach(modal => {
    if (event.target === modal) {
      closeModal();
    }
  });
});

// Close modal on Escape key
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeModal();
  }
});
</script>
{% endblock %}
